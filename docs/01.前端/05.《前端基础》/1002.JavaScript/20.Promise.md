---
title: Promise
date: 2021-10-22 14:35:15
permalink: /pages/2c0044/
categories:
  - å‰ç«¯
  - ã€Šå‰ç«¯åŸºç¡€ã€‹
  - JavaScript
tags:
  - 
---

# Promise

<!-- more -->

https://juejin.cn/post/6945319439772434469

## åŸç”Ÿå†™æ³•

```js
const promise = new Promise((resolve, reject) => {
   resolve('success')
   reject('err')
})

// then çš„å‚æ•°æ˜¯ ä¸¤ä¸ª fn
promise.then(value => {
  console.log('resolve', value)
}, reason => {
  console.log('reject', reason)
})

// è¾“å‡º resolve success
```

**åŸºæœ¬åŸç†**

> 1ã€Promise æ˜¯ä¸€ä¸ªç±»ï¼Œåœ¨æ‰§è¡Œè¿™ä¸ªç±»çš„æ—¶å€™ä¼šä¼ å…¥ä¸€ä¸ªæ‰§è¡Œå™¨ï¼Œè¿™ä¸ªæ‰§è¡Œå™¨ä¼šç«‹å³æ‰§è¡Œ
> 2ã€Promise ä¼šæœ‰ä¸‰ç§çŠ¶æ€
>   - Pending ç­‰å¾…
>   - Fulfilled å®Œæˆ
>   - Rejected å¤±è´¥
> 
> 3ã€çŠ¶æ€åªèƒ½ç”± Pending --> Fulfilled æˆ–è€… Pending --> Rejectedï¼Œä¸”ä¸€ä½†å‘ç”Ÿæ”¹å˜ä¾¿ä¸å¯äºŒæ¬¡ä¿®æ”¹ï¼›
> 4ã€Promise ä¸­ä½¿ç”¨ resolve å’Œ reject ä¸¤ä¸ªå‡½æ•°æ¥æ›´æ”¹çŠ¶æ€ï¼›
> 5ã€then æ–¹æ³•å†…éƒ¨åšä½†äº‹æƒ…å°±æ˜¯çŠ¶æ€åˆ¤æ–­
>   - å¦‚æœçŠ¶æ€æ˜¯æˆåŠŸï¼Œè°ƒç”¨æˆåŠŸå›è°ƒå‡½æ•°
>   - å¦‚æœçŠ¶æ€æ˜¯å¤±è´¥ï¼Œè°ƒç”¨å¤±è´¥å›è°ƒå‡½æ•°

## å®ç°æ­¥éª¤ä¸€ï¼šå…ˆå®ç°æ²¡æœ‰å¼‚æ­¥çš„æƒ…å†µ

```js
// MyPromise.js

// å…ˆå®šä¹‰ä¸‰ä¸ªå¸¸é‡è¡¨ç¤ºçŠ¶æ€
const PENDING = 'pending';
const FULFILLED = 'fulfilled';
const REJECTED = 'rejected';

// æ–°å»º MyPromise ç±»
class MyPromise {
  constructor(executor){
    // executor æ˜¯ä¸€ä¸ªæ‰§è¡Œå™¨ï¼Œè¿›å…¥ä¼šç«‹å³æ‰§è¡Œ
    // å¹¶ä¼ å…¥resolveå’Œrejectæ–¹æ³•
    executor(this.resolve, this.reject)
  }

  // å‚¨å­˜çŠ¶æ€çš„å˜é‡ï¼Œåˆå§‹å€¼æ˜¯ pending
  status = PENDING;

  // resolveå’Œrejectä¸ºä»€ä¹ˆè¦ç”¨ç®­å¤´å‡½æ•°ï¼Ÿ
  // å¦‚æœç›´æ¥è°ƒç”¨çš„è¯ï¼Œæ™®é€šå‡½æ•°thisæŒ‡å‘çš„æ˜¯windowæˆ–è€…undefined
  // ç”¨ç®­å¤´å‡½æ•°å°±å¯ä»¥è®©thisæŒ‡å‘å½“å‰å®ä¾‹å¯¹è±¡
  // æˆåŠŸä¹‹åçš„å€¼
  value = null;
  // å¤±è´¥ä¹‹åçš„åŸå› 
  reason = null;

  // æ›´æ”¹æˆåŠŸåçš„çŠ¶æ€
  resolve = (value) => {
    // åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹
    if (this.status === PENDING) {
      // çŠ¶æ€ä¿®æ”¹ä¸ºæˆåŠŸ
      this.status = FULFILLED;
      // ä¿å­˜æˆåŠŸä¹‹åçš„å€¼
      this.value = value;
    }
  }

  // æ›´æ”¹å¤±è´¥åçš„çŠ¶æ€
  reject = (reason) => {
    // åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹
    if (this.status === PENDING) {
      // çŠ¶æ€æˆåŠŸä¸ºå¤±è´¥
      this.status = REJECTED;
      // ä¿å­˜å¤±è´¥åçš„åŸå› 
      this.reason = reason;
    }
  }

  then(onFulfilled, onRejected) {
    // åˆ¤æ–­çŠ¶æ€
    if (this.status === FULFILLED) {
      // è°ƒç”¨æˆåŠŸå›è°ƒï¼Œå¹¶ä¸”æŠŠå€¼è¿”å›
      onFulfilled(this.value);
    } else if (this.status === REJECTED) {
      // è°ƒç”¨å¤±è´¥å›è°ƒï¼Œå¹¶ä¸”æŠŠåŸå› è¿”å›
      onRejected(this.reason);
    }
  }
}

module.exports = MyPromise
```

## å®ç°æ­¥éª¤äºŒï¼šå®ç°å¼‚æ­¥

**é—®é¢˜**

```js
// test.js

const MyPromise = require('./MyPromise')
const promise = new MyPromise((resolve, reject) => {
  setTimeout(() => {
    resolve('success')
  }, 2000); 
})

promise.then(value => {
  console.log('resolve', value)
}, reason => {
  console.log('reject', reason)
})

// æ²¡æœ‰æ‰“å°ä¿¡æ¯ï¼ï¼ï¼
```

> ä¸»çº¿ç¨‹ä»£ç ç«‹å³æ‰§è¡Œï¼ŒsetTimeout æ˜¯å¼‚æ­¥ä»£ç ï¼Œthen ä¼šé©¬ä¸Šæ‰§è¡Œï¼Œè¿™ä¸ªæ—¶å€™åˆ¤æ–­ Promise çŠ¶æ€ï¼ŒçŠ¶æ€æ˜¯ Pendingï¼Œç„¶è€Œä¹‹å‰å¹¶æ²¡æœ‰åˆ¤æ–­ç­‰å¾…è¿™ä¸ªçŠ¶æ€

è¿™é‡Œå°±éœ€è¦æˆ‘ä»¬å¤„ç†ä¸€ä¸‹ Pending çŠ¶æ€ï¼Œæˆ‘ä»¬æ”¹é€ ä¸€ä¸‹ä¹‹å‰çš„ä»£ç  ğŸ¤”

**1. ç¼“å­˜æˆåŠŸä¸å¤±è´¥å›è°ƒ**

```js
// MyPromise.js

// MyPromise ç±»ä¸­æ–°å¢
// å­˜å‚¨æˆåŠŸå›è°ƒå‡½æ•°
onFulfilledCallback = null;
// å­˜å‚¨å¤±è´¥å›è°ƒå‡½æ•°
onRejectedCallback = null;
```

**2. then æ–¹æ³•ä¸­çš„ Pending çš„å¤„ç†**

```js
// MyPromise.js

then(onFulfilled, onRejected) {
  // åˆ¤æ–­çŠ¶æ€
  if (this.status === FULFILLED) {
    // è°ƒç”¨æˆåŠŸå›è°ƒï¼Œå¹¶ä¸”æŠŠå€¼è¿”å›
    onFulfilled(this.value);
  } else if (this.status === REJECTED) {
    // è°ƒç”¨å¤±è´¥å›è°ƒï¼Œå¹¶ä¸”æŠŠåŸå› è¿”å›
    onRejected(this.reason);
  } else if (this.status === PENDING) {
    // ==== æ–°å¢ ====
    // å› ä¸ºä¸çŸ¥é“åé¢çŠ¶æ€çš„å˜åŒ–æƒ…å†µï¼Œæ‰€ä»¥å°†æˆåŠŸå›è°ƒå’Œå¤±è´¥å›è°ƒå­˜å‚¨èµ·æ¥
    // ç­‰åˆ°æ‰§è¡ŒæˆåŠŸå¤±è´¥å‡½æ•°çš„æ—¶å€™å†ä¼ é€’
    this.onFulfilledCallback = onFulfilled;
    this.onRejectedCallback = onRejected;
  }
}
```

**3. resolve ä¸ reject ä¸­è°ƒç”¨å›è°ƒå‡½æ•°**

```js
// MyPromise.js

// æ›´æ”¹æˆåŠŸåçš„çŠ¶æ€
resolve = (value) => {
  // åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹
  if (this.status === PENDING) {
    // çŠ¶æ€ä¿®æ”¹ä¸ºæˆåŠŸ
    this.status = FULFILLED;
    // ä¿å­˜æˆåŠŸä¹‹åçš„å€¼
    this.value = value;
    // ==== æ–°å¢ ====
    // åˆ¤æ–­æˆåŠŸå›è°ƒæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±è°ƒç”¨
    this.onFulfilledCallback && this.onFulfilledCallback(value);
  }
}

// MyPromise.js
// æ›´æ”¹å¤±è´¥åçš„çŠ¶æ€
reject = (reason) => {
  // åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹
  if (this.status === PENDING) {
    // çŠ¶æ€æˆåŠŸä¸ºå¤±è´¥
    this.status = REJECTED;
    // ä¿å­˜å¤±è´¥åçš„åŸå› 
    this.reason = reason;
    // ==== æ–°å¢ ====
    // åˆ¤æ–­å¤±è´¥å›è°ƒæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±è°ƒç”¨
    this.onRejectedCallback && this.onRejectedCallback(reason)
  }
}
```

æˆ‘ä»¬å†æ‰§è¡Œä¸€ä¸‹ä¸Šé¢çš„ğŸŒ°

```js
// test.js

const MyPromise = require('./MyPromise')
const promise = new MyPromise((resolve, reject) => {
  setTimeout(() => {
    resolve('success')
  }, 2000); 
})

promise.then(value => {
  console.log('resolve', value)
}, reason => {
  console.log('reject', reason)
})

// ç­‰å¾… 2s è¾“å‡º resolve success
```

ç›®å‰å·²ç»å¯ä»¥ç®€å•å¤„ç†å¼‚æ­¥é—®é¢˜äº†âœŒï¸

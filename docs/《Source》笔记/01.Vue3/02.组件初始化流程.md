---
title: 组件初始化流程
date: 2022-05-12 14:58:52
permalink: /pages/dc3275/
categories:
  - 《Source》笔记
  - Vue3
tags:
  - 
---

# Vue3 组件初始化流程

> 关键字：vDom、vnode、mount 挂载、update 更新、patch 补丁

## 前言

你在 Vue3 的项目中如下的调用 createApp 来创建初始的 Vue 组件，然后 Vue 就会自动的去生成相应的组件。

```ts
import {createApp} from 'vue';
import App from './App.vue';

createApp(App).mount('#app')
```

那么 Vue 内部是怎样做到的呢？跟着笔者一起讨论一下吧！如有误，请在评论区留言！阅读此文仅需10分钟，通过图文的方式讲述，包你满意~~~

**前置知识**

首先，咱们要知道 Vue3 的特性之一就是使用 monorepo 的方式进行源代码的管理，这样有利于分包管理。例如 Reactivity 响应式模块是可以不依赖于 Vue 的，单独的引用这个包就可以在其他的项目中使用！其次，Vue3 的渲染器 runtime-core 是不依赖与平台的，可以调用相关的函数并传入 render 进行不同平台的渲染。最后，组件的更新是异步的，通过队列实现的，所以有时候需要用 nextTick 钩子去获取最新的值。 

> vDom(虚拟Dom)是一个对象用来描述真实 Dom 树，而 vnode 则是 vDom 树上的结点，有时也是一颗子树(为组件的时候)，所以 vnode 和 vDom 有时候意思是一样的。

## 挂载组件的流程

**挂载图示**

![](http://66.152.176.25:8000/home/images/artical/组件的挂载流程.png)

**代码展示**

```js
function createAppApi(render) {
    return createApp(rootComponent){
        mount(container){
            const vnode = createVNode(rootComponent)
            render(rootComponent,container)
        }
    }
}
```

```js
function createRenderer() {
    
    function render(vnode, container) {
        // patch 的作用就是循环遍历
        // 同时判断是一个 function 或者是一个 Object
        // TODO patch 作用？
        // 如果是一个 function 
        // 如果是一个 Object 对象就直接插入到上下文对象中
        patch(null, vnode, container, null, null)
    }

    function patch(n1,n2) {
        // n1 是老结点 n2 是新结点
        const {type,shapeFlags} = n2
        switch (type) {
            case Frangment:
                ...
                break;
            case Text:
                processText(n1,n2)
                break;
            default:
                // 通过位运算来判断是 element component
                if(shapeFlag & shapeFlags.ELEMENT){
                    processElement(n1,n2)
                }else if(shapeFlag & shapeFlags.component){
                    processComponent(n1,n2)
                }
                break;
        }
    }

    function processComponent(n1,n2) {
        if(!n1){
            // n1 不存在的时候就是挂载
            mountComponent()
        }else{
            updateComponent()
        }
    }

    function processElement(n1,n2) {
        if(!n1){
            // n1 不存在的时候就是挂载
            mountComponent()
        }else{
            // n1 存在就是比较
            // 这里就设计到 diff 算法
            patchElement()
        }
    }
}
```

## 更新组件的流程

## Ending

**完整的流程图**

![](http://66.152.176.25:8000/home/images/artical/Vue3组件初始化与更新流程.png)

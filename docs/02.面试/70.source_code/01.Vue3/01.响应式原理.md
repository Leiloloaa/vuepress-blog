---
title: å“åº”å¼åŸç†
date: 2021-12-02 16:11:05
permalink: /pages/fab7d2/
categories:
  - é¢è¯•
  - source_code
  - Vue3
tags:
  - 
---

# Reactivity æ ¸å¿ƒ

## å‰è¨€

Vue3 æœ€æ ¸å¿ƒçš„å°±æ˜¯å“åº”å¼æœºåˆ¶çš„å˜åŒ–ï¼Œé‚£ä¹ˆå’Œ Vue2 å“åº”å¼çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

- é¢—ç²’åº¦æ›´ç»†è‡´ï¼Œå¢åŠ é™æ€èŠ‚ç‚¹ã€äº‹ä»¶ä¾¦å¬ç¼“å­˜æœºåˆ¶
  - diff ç®—æ³•å°±ä¸ä¼šå» patch
- ä½¿ç”¨ proxy æ¥æ›¿ä»£ Object.defineProperty()
  - ä¸¤è€…çš„ä¼˜åŠ£å¯¹æ¯”
  - ä¾‹å¦‚ proxy å¤šè¾¾ 13 ç§æ‹¦æˆªæ–¹å¼ï¼Œä¸”å¯ä»¥å¯¹å¯¹è±¡è¿›è¡Œé€ä¸€ç›‘æ§ã€‚è€Œ Object.defineProperty() æ˜¯å¯¹æ•´ä¸ªå¯¹è±¡ã€‚ç­‰ç­‰

**å›¾è§£**

![](http://66.152.176.25:8000/home/images/miniVue/reactive.png)

## å®ç°æ­¥éª¤

Vue3 å“åº”å¼å°±æ˜¯é€šè¿‡ get(å–å€¼æ“ä½œ) çš„æ—¶å€™æ”¶é›†ä¾èµ–ï¼Œset(èµ‹å€¼æ“ä½œ) çš„æ—¶å€™è§¦å‘ä¾èµ–ã€‚

**å’±ä»¬ç›®å‰åªå®ç°æ ¸å¿ƒéƒ¨åˆ†ï¼Œä¸æ¶‰åŠè¾¹ç¼˜ case**

### åˆ›å»º proxy å¯¹æ•°æ®è¿›è¡Œä»£ç†

**éœ€è¦å®ç°çš„å•æµ‹**

```js
// effect.spec.ts
it('effect', () => {
    // reactive æ ¸å¿ƒï¼šget æ”¶é›†ä¾èµ– set è§¦å‘ä¾èµ–
    const user = reactive({
      age: 10
    })
});
```

```js
export function reactive(raw) {
  return new Proxy(raw, {
    get(target, key) {
      const res = Reflect.get(target, key)
      // Proxy è¦å’Œ Reflect é…åˆä½¿ç”¨
      // Reflect.get ä¸­ receiver å‚æ•°ï¼Œä¿ç•™äº†å¯¹æ­£ç¡®å¼•ç”¨ thisï¼ˆå³ adminï¼‰çš„å¼•ç”¨ï¼Œè¯¥å¼•ç”¨å°† Reflect.get ä¸­æ­£ç¡®çš„å¯¹è±¡ä½¿ç”¨ä¼ é€’ç»™ get
      // ä¸ç®¡ Proxy æ€ä¹ˆä¿®æ”¹é»˜è®¤è¡Œä¸ºï¼Œä½ æ€»å¯ä»¥åœ¨ Reflect ä¸Šè·å–é»˜è®¤è¡Œä¸º
      track(target, key)
      return res
    },
    set(target, key, value) {
      // set æ“ä½œæ˜¯ä¼šæ”¾å› true or false
      // set() æ–¹æ³•åº”å½“è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚
      // è¿”å› true ä»£è¡¨å±æ€§è®¾ç½®æˆåŠŸã€‚
      // åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œå¦‚æœ set() æ–¹æ³•è¿”å› falseï¼Œé‚£ä¹ˆä¼šæŠ›å‡ºä¸€ä¸ª TypeError å¼‚å¸¸ã€‚
      const res = Reflect.set(target, key, value)
      trigger(target, key)
      return res
    }
  })
}
```

### æ”¶é›†ä¾èµ–

Vue3 æ˜¯é€šè¿‡ effect å‡½æ•°æ¥æ”¶é›†ä¸å“åº”å¼å˜é‡ç›¸å…³çš„ fnã€‚

**éœ€è¦å®ç°çš„å•æµ‹**

```js
describe('test effect', () => {
  it('effect', () => {
    const user = reactive({
      age: 10
    })
    let nextAge
    effect(() => {
      nextAge = user.age + 1
    })
    expect(nextAge).toBe(11)
  });
});
```

å®ç° effect å‡½æ•°ï¼Œå¹¶å°†ä¼ å…¥çš„å‡½æ•°æ‰§è¡Œã€‚

```js
export class ActiveEffect {
  private _fn: any
  constructor(fn) {
    this._fn = fn
  }
  run() {
    this._fn()
  }
}

export function effect(fn) {
  // é€šè¿‡æ„é€  ActiveEffect æ¥æä¾›å¤šç§å±æ€§å’Œæ–¹æ³•
  const _effect = new ActiveEffect(fn)
  _effect.run()
}
```

å½“å‡½æ•°æ‰§è¡Œ`nextAge = user.age + 1`çš„æ—¶å€™ï¼Œæ˜¯è¦å…ˆ get åˆ° user.age çš„å€¼ï¼Œç„¶åå† set ç»™ nextAgeã€‚

```js
export function reactive(raw) {
  return new Proxy(raw, {
    get(target, key) {
      // æ‹¿åˆ° user.age çš„å€¼
      const res = Reflect.get(target, key)
      // æ”¶é›†ä¾èµ–
      track(target, key)
      return res
    },
  })
}
```

å®ç° trackï¼ŒVue3 æ˜¯é€šè¿‡ Map å’Œ Set å¯¹ fn å’Œ å˜é‡ è¿›è¡Œæ”¶é›†å¤„ç†ã€‚Map çš„å¥½å¤„å°±æ˜¯ï¼Œé”®å¯ä»¥æ˜¯å¯¹è±¡ï¼Œè€Œ Set èƒ½ä¿è¯ fn å”¯ä¸€ã€‚

ä¸¾ä¸ªğŸŒ°

```js
// ä¾‹å¦‚ä½ å®šä¹‰äº†è¿™æ ·ä¸€ä¸ªå˜é‡
const foo = reactive({num:1,age:18})
// åœ¨ Vue3 ä¸­æ˜¯è¿™æ ·ä¿å­˜çš„
targetMap={
  {num:1,age:18}:{
     num:(fn1,fn2),
     age:(fn1,fn2)
  }
}
// å¦‚æœæœ‰å¤šä¸ªï¼Œå¦‚ä¸‹
targetMap(weakMap) = {
     target1(Map): {
       key1(dep_Set): (fn1,fn2,fn3...)
       key2(dep_Set): (fn1,fn2,fn3...)
     },
    target2(Map): {
       key1(dep_Set): (fn1,fn2,fn3...)
       key2(dep_Set): (fn1,fn2,fn3...)
       },
}
```

```js
// å®šä¹‰å…¨å±€å˜é‡ targetsMap
// WeakSet çš„å¥½å¤„å°±æ˜¯ WeakSet ä¸­çš„å¯¹è±¡éƒ½æ˜¯å¼±å¼•ç”¨
const targetsMap = new WeakSet()
// æ”¶é›†ä¾èµ–
export function track(target, key) {
  // reactive ä¼ å…¥çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ {}
  // æ”¶é›†å…³ç³»ï¼š targetsMap æ”¶é›†æ‰€æœ‰ä¾èµ– ç„¶å æ¯ä¸€ä¸ª {} ä½œä¸ºä¸€ä¸ª depsMap
  // å†æŠŠ {} é‡Œé¢çš„æ¯ä¸€ä¸ªå˜é‡ä½œä¸º dep(set ç»“æ„) çš„ key å­˜æ”¾æ‰€æœ‰çš„ fn
  let depsMap = targetsMap.get(target)
  // ä¸å­˜åœ¨çš„æ—¶å€™ è¦å…ˆåˆå§‹åŒ–
  if (!depsMap) {
    depsMap = new Map()
    targetsMap.set(target, depsMap)
  }
  let dep = depsMap.get(key)
  if (!dep) {
    dep = new Set()
    depsMap.set(key, dep)
  }

  // è¦å­˜å…¥çš„æ˜¯ä¸€ä¸ª fnï¼Œè¿™ä¸ª fn æ˜¯ effect ä¸­ä¼ å…¥å¹¶æ‰§è¡Œçš„å‡½æ•°
  // æ‰€ä»¥è¦åˆ©ç”¨ä¸€ä¸ªå…¨å±€å˜é‡
  dep.add(activeEffect)
}

let activeEffect
export class ActiveEffect {
  ...
  run() {
    // === æ–°å¢ ===
    activeEffect = this
  }
}
```

### è§¦å‘ä¾èµ–

åˆšåˆšå’±ä»¬å®ç°äº†è§¦å‘ get çš„æ—¶å€™æ”¶é›†ä¾èµ–ï¼Œç°åœ¨æ¥å®ç°è§¦å‘ set çš„æ—¶å€™è§¦å‘ä¾èµ–ã€‚

**éœ€è¦å®ç°çš„å•æµ‹**

```js
describe('test effect', () => {
  it('effect', () => {
    // update
    // user.age++ => user.age = use.age + 1
    user.age++
    expect(nextAge).toBe(12)
  });
});
```

```js
export function reactive(raw) {
  return new Proxy(raw, {
    ...
    set(target, key, value) {
      const res = Reflect.set(target, key, value)
      trigger(target, key)
      return res
    }
  })
}
```

```js
// è§¦å‘ä¾èµ–
// æˆ‘ä»¬åªéœ€è¦é€šè¿‡ç›¸åº”çš„ depï¼Œç„¶åéå†æ‰§è¡Œ fnï¼Œæ‰€æœ‰çš„ä¾èµ–çš„å€¼å°±ä¼šæ”¹å˜
export function trigger(target, key) {
  let depsMap = targetsMap.get(target)
  let dep = depsMap.get(key)
  for (const effect of dep) {
    effect.run()
  }
}
```

## æ€»ç»“

é€šè¿‡ TDD å•æµ‹é©±åŠ¨å­¦ä¹ ï¼Œæ›´æœ‰æ•ˆçš„è®©ä½ äº†è§£è¿è¡Œçš„æœºåˆ¶ã€‚Vue3 çš„æºç å†…ä¹Ÿæä¾›äº†å¤§é‡çš„æµ‹è¯•ã€‚æœ¬èŠ‚ï¼Œå’±ä»¬å¤§æ¦‚çš„è®²è¿°äº†æ”¶é›†ä¾èµ–å’Œè§¦å‘ä¾èµ–çš„è¿‡ç¨‹ï¼Œæœ¬èŠ‚è°ƒè¯•ä»£ç é“¾æ¥åœ¨æ–‡ç« å¼€å¤´ã€‚å­¦ä¹ æºç ä¸€å®šè¦å¤šæ€è€ƒï¼Œä¸ºä»€ä¹ˆä¼šè¿™ä¹ˆåšï¼Ÿè¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿç­‰ç­‰ã€‚æœ€åï¼Œæ¨èå¤§å®¶ï¼Œå­¦ä¹  Vue3 æºç æ—¶ï¼Œå¯ä»¥è·Ÿç€ mini-vue3 ä½œè€…ä¸€èµ·æ•²ã€‚æœ‰æƒ³åŠ ç¾¤çš„å°ä¼™ä¼´ï¼Œè¯„è®ºåŒºè”ç³»æˆ‘å‘€ï¼(æ²¡äººå¸¦ï¼Œä¸¾æ­¥ç»´è‰°ï¼æœ‰äººå¸¦ï¼Œäº‹åŠåŠŸå€ï¼)
---
title: 10å¼ å›¾ã€10åˆ†é’Ÿï¼ŒåŒ…ä½ å­¦ä¼š Vue3 çš„â€œå·¦å³äº’åšâ€
date: 2022-01-11 14:59:41
permalink: /pages/9c089c/
categories:
  - é¢è¯•
  - vue3 diff ç®—æ³•
tags:
  - 
---

# 10å¼ å›¾ã€10åˆ†é’Ÿï¼ŒåŒ…ä½ å­¦ä¼š Vue3 çš„â€œå·¦å³äº’åšâ€

è¯è¯´åœ¨`å°„é›•ä¸‰éƒ¨æ›²`ä¸­è®ºå“ªé—¨æ­¦åŠŸæ¯”è¾ƒæœ‰æ„æ€ï¼Œç¬”è€…è®¤ä¸ºå·¦å³äº’åšåº”è¯¥å¯ä»¥åŠ å…¥ç¾¤èŠã€‚ä½ ä¹Ÿå¯ä»¥å°è¯•ä¸€ä¸‹å·¦æ‰‹ç”»åœ†ã€å³æ‰‹ç”»æ–¹ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯æ­ªä¸ƒæ‰­å…«çš„ã€‚å’³å’³ï¼Œå†è¯´ä¸‹å»ä½ éƒ½ä¼šç»™ç¬”è€…å‡ é­å­ã€‚å’±ä»¬è¿˜æ˜¯è®¨è®ºä¸€ä¸‹ Vue3 çš„å·¦å³äº’åšä¹‹æœ¯å§ï¼

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c49cd738d3b04716ab038d07738f775b~tplv-k3u1fbpfcp-watermark.image?)

**å£°æ˜ï¼šå·¦å³äº’åš â‰ˆ åŒç«¯å¯¹æ¯”**

è¿›å…¥æ­£é¢˜ä¹‹å‰ï¼Œç¬”è€…è®¤ä¸ºæœ‰å¿…è¦å¤ä¹ è™šæ‹Ÿ dom å’Œ diff ç®—æ³•ï¼Œæ¥ï¼Œå®¢å®˜è¯·æ¥æ‹›~

**å‰ç½®çŸ¥è¯†**

- è™šæ‹Ÿ dom
  - `æ˜¯ä¸€ä¸ªå¯¹è±¡`ï¼Œæˆ‘ä»¬å°†çœŸå®çš„ dom é€šè¿‡æŸç§æ–¹å¼è½¬æ¢æˆä¸€ä¸ª å¯¹è±¡
  - å¯¹è±¡çš„å¥½å¤„å°±æ˜¯`è·¨å¹³å°`ï¼Œå¦‚ä»Šçš„ json å°±æ˜¯æœ€å¥½çš„ä¾‹å­
  - æ“ä½œè™šæ‹Ÿ dom å’Œ æ“ä½œçœŸå® dom å“ªä¸ªå¿«ï¼ˆæœ‰æ—¶é—´å¯ä»¥é˜…è¯»ä¸€ä¸‹ [å°¤å¤§çš„çŸ¥ä¹å›ç­”](https://www.zhihu.com/question/31809713)ï¼‰ï¼Œç®€è¨€ä¹‹ï¼Œçº¯çœ‹é€Ÿåº¦çœŸå®DOM > è™šæ‹ŸDOMï¼Œåè€…éœ€è¦å¯¹æ¯”å¾—å‡ºå·®å¼‚æ‰æ›´æ–°ã€‚ä½†æ˜¯åŸºäºæ€§èƒ½æ¥è¯´`å·®å¼‚æ›´æ–°`è¦æ¯”`å…¨é‡æ›´æ–°`äº§ç”Ÿçš„`ä»£ä»·æ›´ä¾¿å®œ`

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/62de6f2f6eff42c08a6a4fa354405a46~tplv-k3u1fbpfcp-watermark.image?)

- diff ç®—æ³•
  - Vue3 æ˜¯é€šè¿‡`åŒç«¯å¯¹æ¯”`+`æœ€é•¿é€’å¢å­åºåˆ—`ç®—æ³•å¾—å‡ºæœ€å°çš„æ›´æ–°æ¶ˆè€—
  - åŒç«¯å¯¹æ¯”ï¼šä¸¤ä¸ªæŒ‡é’ˆä¸€ä¸ªä»å‰é¢å¼€å§‹ï¼Œä¸€ä¸ªä»åé¢å¼€å§‹ï¼Œå¾—å‡ºä¸­é—´æ”¹å˜çš„éƒ¨åˆ†
  - æœ€é•¿é€’å¢å­åºåˆ—ï¼šä¸­é—´ä¹±åºéƒ¨åˆ†ï¼Œé€šè¿‡æ–°è€å¯¹æ¯”å¾—å‡ºæ–°çš„èŠ‚ç‚¹ä¸­`å…ƒç´ `ä¸è€èŠ‚ç‚¹ä¸­`ç›¸å¯¹ä½ç½®`ä¸éœ€è¦æ”¹å˜çš„åºåˆ—

**äº®å‰‘ï¼šå¸¸è§çš„æ›´æ–°é—®é¢˜**

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/faeab34c60974332bb3293369e440b18~tplv-k3u1fbpfcp-watermark.image?)

ä¸ºäº†èŠ‚çº¦å¤§å®¶çš„æ—¶é—´ä»¥åŠ diff ç®—æ³•ä¸»è¦è¿ç”¨åœ¨ç¬¬å››ç§æƒ…å†µï¼Œæ‰€ä»¥åœ¨æœ¬æ–‡ç¬”è€…ä¸ä½ ä¸€èµ·è®¨è®º old array => new arrayã€‚

**ä¸¾ä¸ªğŸŒ°**

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a7c5ec73ef524371a72f8b5bf96fbd20~tplv-k3u1fbpfcp-watermark.image?)

å¦‚å›¾æ‰€ç¤ºï¼Œå˜åŒ–æ— éæœ‰ä»¥ä¸‹ä¸‰ç§ï¼š

- ç§»åŠ¨ï¼Œcã€dã€e ä½ç½®ä¸ä¸€æ ·äº†
- åˆ é™¤ï¼Œf ä¸å­˜åœ¨äº†
- æ–°å¢ï¼Œe æ˜¯æ–°åŠ çš„

é‚£ä¹ˆï¼Œæˆ‘ä»¬è¦æ€æ ·ç¡®å®šé‚£äº›å…ƒç´ å˜åŠ¨äº†å‘¢ï¼Ÿåˆæ˜¯ä»å“ªä¸ªå…ƒç´ å¼€å§‹å˜åŠ¨çš„ï¼Ÿ

**ä»»åŠ¡æ‹†è§£**

- ç¡®å®šå·¦è¾¹å¼€å§‹å˜åŠ¨çš„ä½ç½® => å·¦åºéå†
- ç¡®å®šå³è¾¹å¼€å§‹å˜åŠ¨çš„ä½ç½® => å³åºéå†

Vue æä¾›äº†ä¸€ç§æ–¹æ¡ˆ => åŒç«¯å¯¹æ¯”ç®—æ³•ï¼Œä¹Ÿå°±æ˜¯å’±ä»¬å¼€å¤´è¯´çš„å·¦å³äº’åšï¼Œå…·ä½“çš„çœ‹ä¸‹å›¾ï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4dde9376a25749be97f8b8770d3d7355~tplv-k3u1fbpfcp-watermark.image?)

ä¸‰ä¸ªæŒ‡é’ˆ iã€e1ã€e2ï¼Œi è¡¨ç¤ºä»å·¦è¾¹å¼€å§‹å˜åŠ¨çš„ä½ç½®ï¼Œe1 å’Œ e2 åˆ†åˆ«è¡¨ç¤ºæ–°è€èŠ‚ç‚¹ä»å³è¾¹å¼€å§‹å˜åŠ¨çš„ä½ç½®ã€‚é€šè¿‡å¾ªç¯ new tree çš„èŠ‚ç‚¹ï¼Œæ¥ç¡®å®šå˜åŠ¨ä½ç½®ï¼Œæœ€ç»ˆæˆ‘ä»¬ä¼šå¾—å¦‚å›¾æ‰€ç¤ºçš„ç»“æœï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de97c29726fb4b3aa651b2b140d8db59~tplv-k3u1fbpfcp-watermark.image?)

æ¥ä¸‹æ¥ï¼Œå’±ä»¬å…·ä½“çš„çœ‹ä¸‹å·¦åºéå†å’Œå³åºéå†çš„å®ç°æ–¹å¼ã€‚

## å·¦åºéå†

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b9d16241db4148cf9ec13fa7ed6c6b65~tplv-k3u1fbpfcp-watermark.image?)

å’±ä»¬çš„ç›®çš„æ˜¯è¦ç¡®å®š i çš„ä½ç½®ï¼Œé¦–å…ˆå¾—æ¸…æ¥šå¾ªç¯æ¡ä»¶ï¼Œä»€ä¹ˆæ—¶å€™è¯¥é€€å‡ºå¾ªç¯ã€‚å› ä¸ºæ–°è€èŠ‚ç‚¹éƒ½æ˜¯`æ•°ç»„`ï¼Œæ‰€ä»¥ `i` è¦å°äºæˆ–ç­‰äº `e1(è€èŠ‚ç‚¹çš„æœ€åä¸€ä½)` å’Œ `e2(æ–°èŠ‚ç‚¹çš„æœ€åä¸€ä½)`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
// æ¯”è¾ƒå‡½æ•° c1 ä¸ºè€çš„è™šæ‹ŸèŠ‚ç‚¹ c2 ä¸ºæ–°çš„è™šæ‹ŸèŠ‚ç‚¹
// c ä¸º children çš„ç®€å†™ï¼Œe ä¸º element çš„ç®€å†™
function patchKeyedChildren(c1, c2){
    const len2 = c2.length // åé¢å¤šæ¬¡ç”¨åˆ°ï¼Œæå–
    // å®šä¹‰ä¸‰ä¸ªæŒ‡é’ˆ
    let i = 0  // ä»æ–°çš„èŠ‚ç‚¹å¼€å§‹
    let e1 = c1.length - 1 // è€çš„æœ€åä¸€ä¸ª ç´¢å¼•å€¼
    let e2 = len2 - 1 // æ–°çš„æœ€åä¸€ä¸ª ç´¢å¼•å€¼
    // ç§»åŠ¨ i æŒ‡é’ˆ
    while (i <= e1 && i <= e2) {
      const n1 = c1[i];
      const n2 = c2[i];
      if (isSomeVNodeType(n1, n2)) {
        // ... åœ¨å¾ªç¯çš„æ¯”è¾ƒæ­¤èŠ‚ç‚¹å†…çš„èŠ‚ç‚¹
        // patch
      } else {
        break;
      }
      i++;
    }
    // ç²—ç•¥çš„æ¯”è¾ƒï¼Œå®é™…å¯¹æ¯”è¦æ›´å¤æ‚
    function isSomeVNodeType(n1, n2) {
      // å¯¹æ¯”èŠ‚ç‚¹æ˜¯å¦ç›¸ç­‰ å¯ä»¥é€šè¿‡ type å’Œ key
      return n1.type === n2.type && n1.key === n2.key
    }
}
```

å·¦åºç®—æ³•ï¼Œæˆ‘ä»¬ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š

- å¾ªç¯ i ï¼Œæ‹¿åˆ° c1[i] å’Œ c2[i]
- å¦‚æœç›¸ç­‰ï¼Œå°±ç»§ç»­å¾ªç¯æ¯”è¾ƒï¼Œå¯¹æ¯”åˆ°å¤´ï¼Œå…¨éƒ½ä¸€æ ·çš„ï¼Œå°± i++ï¼Œç§»åŠ¨æŒ‡é’ˆ
- å¦‚æœä¸ç›¸ç­‰ï¼Œå°±ç»“æŸæ¯”è¾ƒï¼Œåœæ­¢ç§»åŠ¨æŒ‡é’ˆ

å·¦è¾¹å˜åŠ¨çš„ä½ç½®ç¡®å®šåï¼Œæ¥ä¸‹æ¥å°±ç¡®å®šå³è¾¹å˜åŠ¨çš„ä½ç½®ï¼Œè¿™å°±æ˜¯ä»»åŠ¡åˆ†è§£ã€‚æ¥ä¸‹æ¥å’±ä»¬çœ‹ä¸‹å³åºéå†æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ

## å³åºéå†

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/638102b21cde4c3a8057b5045cf9df50~tplv-k3u1fbpfcp-watermark.image?)

å’±ä»¬ä»å³è¾¹å¼€å§‹éå†ï¼Œé‚£å¾ªç¯æ¡ä»¶æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ˜¯ä¸æ˜¯ä¹Ÿåªéœ€è¦ i <= e1 å’Œ i <= e2 å°±è¡Œäº†å‘€ï¼i çš„ä½ç½®ç¡®å®šäº†ï¼Œä¸´ç•Œå€¼æ— éæ˜¯ i = e1 æˆ– i = e2 çš„æƒ…å†µã€‚e1 å’Œ e2 åˆ†åˆ«æ˜¯è€èŠ‚ç‚¹å’Œæ–°èŠ‚ç‚¹çš„æœ€åä¸€ä¸ªçš„ç´¢å¼•å€¼ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š

```js
function patchKeyedChildren(c1, c2){
    const len2 = c2.length 
    let i = 0  // ä»æ–°çš„èŠ‚ç‚¹å¼€å§‹
    let e1 = c1.length - 1 // è€çš„æœ€åä¸€ä¸ª ç´¢å¼•å€¼
    let e2 = len2 - 1 // æ–°çš„æœ€åä¸€ä¸ª ç´¢å¼•å€¼
    // å·¦åºéå†
    while (i <= e1 && i <= e2) {
      ...
      i++;
    }
    // å³åºéå†
    while (i <= e1 && i <= e2) {
      const n1 = c1[e1];
      const n2 = c2[e2];
      if (isSomeVNodeType(n1, n2)) {
        // ... åœ¨å¾ªç¯çš„æ¯”è¾ƒæ­¤èŠ‚ç‚¹å†…çš„èŠ‚ç‚¹
        // patch
      } else {
        break;
      }
      e1--;
      e2--;
    }
    // ç²—ç•¥çš„æ¯”è¾ƒï¼Œå®é™…å¯¹æ¯”è¦æ›´å¤æ‚
    function isSomeVNodeType(n1, n2) {
      // å¯¹æ¯”èŠ‚ç‚¹æ˜¯å¦ç›¸ç­‰ å¯ä»¥é€šè¿‡ type å’Œ key
      return n1.type === n2.type && n1.key === n2.key
    }
}
```

ç»†çœ‹ä»£ç ï¼Œå³åºéå†å…¶å®å°±æ˜¯æ‹¿åˆ°è€èŠ‚ç‚¹å’Œæ–°èŠ‚ç‚¹çš„æœ€åä¸€ä¸ªå€¼å¯¹æ¯”ï¼Œç›¸ç­‰çš„è¯ï¼Œe1--ã€e2-- å¾€å‰ç§»åŠ¨ï¼Œä¸ç›¸ç­‰å°±åœæ­¢ç§»åŠ¨ã€‚

## ä¸­é—´ä¹±åºéƒ¨åˆ†

ç»è¿‡å·¦åºéå†å’Œå³åºéå†ï¼Œæˆ‘ä»¬å¾—å‡ºäº†ä»¥ä¸‹çš„ç»“æœï¼Œåœˆå‡ºæ¥çš„å°±æ˜¯ä¹±åºçš„éƒ¨åˆ†ã€‚

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de97c29726fb4b3aa651b2b140d8db59~tplv-k3u1fbpfcp-watermark.image?)

å› ä¸ºæ­¤éƒ¨åˆ†ç¯‡å¹…è¾ƒé•¿ï¼Œæ¶‰åŠåˆ°æœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•ï¼Œå’±ä»¬å¯ä»¥ç§»æ­¥ => [ä¼ é€é—¨](https://juejin.cn/post/7054055241704013831) ä¸€èµ·è®¨è®ºã€‚

## å†™åœ¨æœ€å

æœ€åï¼Œä¸€å›¾å¸®ä½ å†çœ‹ä¸€ä¸‹å·¦åºéå†å’Œå³åºéå†ã€‚

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f15abebeed714ffc958adee485047941~tplv-k3u1fbpfcp-watermark.image?)

å¦å¤–ï¼Œå¦‚æœä½ æƒ³å­¦ä¹  Vue3 æºç ï¼Œæ¨èå…ˆå…¥æ‰‹ [mini-vue](https://github.com/cuixiaorui/mini-vue)ï¼Œå¸¦ä½ å®ç° Vue3 æœ€ç®€æ¨¡å‹ã€‚